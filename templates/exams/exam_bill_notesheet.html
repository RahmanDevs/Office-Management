<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Exam Duty Roster</title>

  <!-- Select2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f9fc;
      padding: 30px;
    }

    h2 {
      text-align: center;
      color: #333;
    }

    form {
      background: #fff;
      padding: 25px;
      max-width: 1000px;
      margin: auto;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
    }

    .course-row {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #f1f5f9;
      position: relative;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 15px;
      align-items: flex-start;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      min-width: 250px;
      flex: 1;
    }

    .form-group label {
      font-weight: bold;
      margin-bottom: 5px;
    }

    select,
    input[type="text"] {
      padding: 8px 10px;
      border: 1.5px solid #bbb;
      border-radius: 5px;
      font-size: 14px;
      width: 100%;
    }

    .select2-container {
      width: 100% !important;
    }

    button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button[type="button"] {
      background-color: #3498db;
      color: white;
      margin-right: 10px;
    }

    button[type="submit"] {
      background-color: #2ecc71;
      color: white;
    }

    button:hover {
      opacity: 0.9;
    }

    .close-container {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 40px;
      height: 40px;
      cursor: pointer;
    }

    .leftright,
    .rightleft {
      height: 5px;
      width: 30px;
      position: absolute;
      top: 5px;
      right: -5px;
      background-color: #F4A259;
      border-radius: 2px;
      transition: all 0.3s ease-in;
    }

    .leftright {
      transform: rotate(45deg);
    }

    .rightleft {
      transform: rotate(-45deg);
    }

    .close-container:hover .leftright,
    .close-container:hover .rightleft {
      background-color: #F25C66;
    }

    .close-container:hover label.close {
      opacity: 1;
    }

    label.close {
      color: white;
      font-size: 0.6em;
      text-transform: uppercase;
      letter-spacing: 2px;
      transition: all 0.3s ease-in;
      opacity: 0;
      position: absolute;
      top: 45px;
      left: 5px;
    }
  </style>
</head>
<body>

<h2>Exam Bill Notesheet</h2>

<form id="notesheet-form" onsubmit="event.preventDefault(); submitForm();">
  <div class="row">
    <div class="form-group">
      <label>Program</label>
      <select name="program" required>
        <option value="">--Select Program--</option>
        <option value="BTIS">BTIS</option>
        <option value="MTIS">MTIS</option>
      </select>
    </div>
    <div class="form-group">
      <label>Semester</label>
      <select name="semester" required>
        <option value="">--Select Semester--</option>
        <option value="1st">1st</option>
        <option value="2nd">2nd</option>
        <option value="3rd">3rd</option>
        <option value="4th">4th</option>
        <option value="5th">5th</option>
        <option value="6th">6th</option>
        <option value="7th">7th</option>
        <option value="8th">8th</option>
      </select>
    </div>
    <div class="form-group">
      <label>Exam Year</label>
      <select name="exam_year" required>
        <option value="">--Select Year--</option>
        <option value="2024">2024</option>
        <option value="2025">2025</option>
        <option value="2026">2026</option>
      </select>
    </div>
    <div class="form-group">
      <label>Exam Type</label>
      <select name="exam_type" required>
        <option value="">--Select Type--</option>
        <option value="regular">Regular</option>
        <option value="supply_rec">Retake/Supplementary</option>
        <option value="special">Special</option>
      </select>
    </div>
    <div class="form-group">
      <label>Chair of Exam Committee</label>
      <select name="chair_exam_committee">
          <option value="">--Select Chair--</option>
      {% for teacher in teachers %}
        <option value="{{ teacher.id }}">{{ teacher.full_name_en }}</option>
      {% endfor %}
      </select>
    </div>
  </div>



  <hr><br>
  <div id="courses"></div>

    <div class="course-row">
      <div class="row">
        <div class="form-group">
          <label>Number Of Teacher</label>
          <input value="14" name="num_of_teacher" type="text" style="width:97%" required>
        </div>
        <div class="form-group">
          <label>Total Amount</label>
          <input name="amount" type="text" style="width:97%" required>
        </div>
    </div>

  <button type="submit">Generate</button>
</form>

<!-- div for url -->
<div id="url-container" style="display: none;">
  <input type="text" id="submit_exam_roster_url" value="{% url 'exam_bill_notesheet' %}" readonly>
</div>



<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>

const submit_exam_roster_url = document.getElementById('submit_exam_roster_url').value;


// CSRF for Django
function getCookie(name) {
  let cookieValue = null;
  document.cookie.split(';').forEach(cookie => {
    const trimmed = cookie.trim();
    if (trimmed.startsWith(name + '=')) {
      cookieValue = decodeURIComponent(trimmed.substring(name.length + 1));
    }
  });
  return cookieValue;
}

// SUBMIT AS JSON
function submitForm() {
  const form = document.getElementById('notesheet-form');
  console.log("I am OK")
  const data = {
    program: form.program.value,
    semester: form.semester.value,
    exam_year: form.exam_year.value,
    exam_type: form.exam_type.value,
    chair_exam_committee: form.chair_exam_committee.value,
    num_of_teacher: form.num_of_teacher.value,
    amount: form.amount.value
  };



  fetch(submit_exam_roster_url, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify(data)
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    const disposition = response.headers.get('Content-Disposition');
    const match = disposition && disposition.match(/filename="?(.+)"?/);
    console.log(disposition)
    const filename = match ? match[1] : 'exam_roster.docx';

    return response.blob().then(blob => ({ blob, filename })); // receive binary file
  })
  .then(({ blob, filename }) => {
    // Create a link and trigger download
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    window.URL.revokeObjectURL(url);
  })
  .catch(err => {
    alert('Submission failed!');
    console.error(err);
  });

}

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Exam Resulation-1</title>

  <!-- Select2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f9fc;
      padding: 30px;
    }

    h2 {
      text-align: center;
      color: #333;
    }

    form {
      background: #fff;
      padding: 25px;
      max-width: 1000px;
      margin: auto;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
    }

    .course-row {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #f1f5f9;
      position: relative;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 15px;
      align-items: flex-start;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      min-width: 250px;
      flex: 1;
    }

    .form-group label {
      font-weight: bold;
      margin-bottom: 5px;
    }

    select,
    input[type="date"] {
      padding: 8px 10px;
      border: 1.5px solid #bbb;
      border-radius: 5px;
      font-size: 14px;
      width: 100%;
    }

    .select2-container {
      width: 100% !important;
    }
    .select2-results__options {
    max-height: 400px !important;   /* increase this */
    overflow-y: auto !important;
}

    button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button[type="button"] {
      background-color: #3498db;
      color: white;
      margin-right: 10px;
    }

    button[type="submit"] {
      background-color: #2ecc71;
      color: white;
    }

    button:hover {
      opacity: 0.9;
    }

    .close-container {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 40px;
      height: 40px;
      cursor: pointer;
    }

    .leftright,
    .rightleft {
      height: 5px;
      width: 30px;
      position: absolute;
      top: 5px;
      right: -5px;
      background-color: #F4A259;
      border-radius: 2px;
      transition: all 0.3s ease-in;
    }

    .leftright {
      transform: rotate(45deg);
    }

    .rightleft {
      transform: rotate(-45deg);
    }

    .close-container:hover .leftright,
    .close-container:hover .rightleft {
      background-color: #F25C66;
    }

    .close-container:hover label.close {
      opacity: 1;
    }

    label.close {
      color: white;
      font-size: 0.6em;
      text-transform: uppercase;
      letter-spacing: 2px;
      transition: all 0.3s ease-in;
      opacity: 0;
      position: absolute;
      top: 45px;
      left: 5px;
    }
  </style>
</head>
<body>

<h2>Exam Resulation-1</h2>

<form id="exam-resulation-form" onsubmit="event.preventDefault(); submitForm();">
  <div class="row">
    <div class="form-group">
      <label>Exam Year</label>
      <select name="academic_year" required>
        <option value="">--Select Year--</option>
        {% for year in academic_years %}
          <option value="{{ year.year }}">{{ year.year }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="form-group">
      <label>Exam Committee</label>
      <select name="exam_committee" required>
        <option value="">--Select Program--</option>
      </select>
    </div>
  </div>
  <div class="row">
    
    <div class="form-group">
      <label>Exam Type</label>
      <select name="exam_type" required>
        <option value="">--Select Type--</option>
        <option value="regular">Regular</option>
        <option value="supply_rec">Retake/Supplementary</option>
        <option value="special">Special</option>
      </select>
    </div>
    
    <div class="form-group">
      <label>Semester</label>
      <select name="semester" required>
        <option value="">--Select Semester--</option>
        {% for sem in semesters %}
          <option value="{{ sem }}">{{ sem }}</option>
        {% endfor %}
      </select>
    </div>
  </div>
  <hr>

  <div class="row">
    <div class="form-group">
      <label>Question Submission Deadline</label>
      <input type="date" name="question_submission_deadline" required>
    </div>
    <div class="form-group">
      <label>Question Moderation Date</label>
      <input type="date" name="question_moderation_date" required>
    </div>
  </div>
  <div class="row">
    <div class="form-group">
      <label>Viva Date (1)</label>
      <input type="date" name="viva_date_1" required>
    </div>
    <div class="form-group">
      <label>Viva Date (2)</label>
      <input type="date" name="viva_date_2" required>
    </div>
  </div>
  <div class="row">
    <div class="form-group">
      <label>Duty Roster Made By</label>
      <select name="duty_roster_made_by" required>
        <option value="">--Select Teacher--</option>
        {% for teacher in teachers %}
          <option value="{{ teacher.full_name_ansi }}">{{ teacher.full_name_en }}</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <div id="courses"></div>


  <button type="submit">Generate</button>
</form>

<!-- div for url -->
<div id="url-container" style="display: none;">
  <input type="text" id="submit_exam_resulation_url" value="{% url 'generate_exam_resulation' %}" readonly>
</div>



<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>



// Get Programs based on Academic Year
document.querySelector('select[name="academic_year"]').addEventListener('change', function() {
    const academic_year = this.value;
    console.log('Selected Academic Year:', academic_year);
    exam_committeeSelect = document.querySelector('select[name="exam_committee"]');
    exam_committeeSelect.innerHTML = '<option value="">--Select Exam Committee--</option>';

    if (academic_year) {
        fetch(`/academic/get_exam_committee/?academic_year=${academic_year}`)
        .then(response => response.text())
        .then(data => {
          /*
          if get data successfully data will be like 
          {
            "code": 200,
            "data": [
              "1: Committee A",
              "2: Committee B"
            ] 
          }

          if error occurs data will be like 
          {
            "code": 404,
            "message": "Academic Year not found"
          }
          */
          const jsonData = JSON.parse(data);

          if (jsonData.code === 200) {
              const committees = jsonData.data;
              committees.forEach(item => {
                  const [pk, title] = item.split(': ');
                  const option = document.createElement('option');
                  option.value = pk;
                  option.textContent = title;
                  exam_committeeSelect.appendChild(option);
              });
          } else {
              console.error('Error:', jsonData.message);
          }
        })
        .catch(err => console.error('Error fetching programs:', err));
    }
});


const submit_exam_resulation_url = document.getElementById('submit_exam_resulation_url').value;

// CSRF for Django
function getCookie(name) {
  let cookieValue = null;
  document.cookie.split(';').forEach(cookie => {
    const trimmed = cookie.trim();
    if (trimmed.startsWith(name + '=')) {
      cookieValue = decodeURIComponent(trimmed.substring(name.length + 1));
    }
  });
  return cookieValue;
}

// SUBMIT AS JSON
function submitForm() {
  const form = document.getElementById('exam-resulation-form');
  const data = {
    academic_year: form.academic_year.value,
    exam_committee: form.exam_committee.value,
    semester: form.semester.value,
    exam_type: form.exam_type.value,
    question_submission_deadline: form.question_submission_deadline.value,
    question_moderation_date: form.question_moderation_date.value,
    viva_date_1: form.viva_date_1.value,
    viva_date_2: form.viva_date_2.value,
    duty_roster_made_by: form.duty_roster_made_by.value,

  };



  fetch(submit_exam_resulation_url, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify(data)
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    const disposition = response.headers.get('Content-Disposition');
    const match = disposition && disposition.match(/filename="?(.+)"?/);
    console.log(disposition)
    const filename = match ? match[1] : 'exam_resulation.docx';

    return response.blob().then(blob => ({ blob, filename })); // receive binary file
  })
  .then(({ blob, filename }) => {
    // Create a link and trigger download
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    window.URL.revokeObjectURL(url);
  })
  .catch(err => {
    alert('Submission failed!');
    console.error(err);
  });

}

</script>
</body>
</html>

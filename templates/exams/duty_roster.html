<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Exam Duty Roster</title>

  <!-- Select2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f9fc;
      padding: 30px;
    }

    h2 {
      text-align: center;
      color: #333;
    }

    form {
      background: #fff;
      padding: 25px;
      max-width: 1000px;
      margin: auto;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
    }

    .course-row {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #f1f5f9;
      position: relative;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 15px;
      align-items: flex-start;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      min-width: 250px;
      flex: 1;
    }

    .form-group label {
      font-weight: bold;
      margin-bottom: 5px;
    }

    select,
    input[type="date"] {
      padding: 8px 10px;
      border: 1.5px solid #bbb;
      border-radius: 5px;
      font-size: 14px;
      width: 100%;
    }

    .select2-container {
      width: 100% !important;
    }
    .select2-results__options {
    max-height: 400px !important;   /* increase this */
    overflow-y: auto !important;
}

    button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button[type="button"] {
      background-color: #3498db;
      color: white;
      margin-right: 10px;
    }

    button[type="submit"] {
      background-color: #2ecc71;
      color: white;
    }

    button:hover {
      opacity: 0.9;
    }

    .close-container {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 40px;
      height: 40px;
      cursor: pointer;
    }

    .leftright,
    .rightleft {
      height: 5px;
      width: 30px;
      position: absolute;
      top: 5px;
      right: -5px;
      background-color: #F4A259;
      border-radius: 2px;
      transition: all 0.3s ease-in;
    }

    .leftright {
      transform: rotate(45deg);
    }

    .rightleft {
      transform: rotate(-45deg);
    }

    .close-container:hover .leftright,
    .close-container:hover .rightleft {
      background-color: #F25C66;
    }

    .close-container:hover label.close {
      opacity: 1;
    }

    label.close {
      color: white;
      font-size: 0.6em;
      text-transform: uppercase;
      letter-spacing: 2px;
      transition: all 0.3s ease-in;
      opacity: 0;
      position: absolute;
      top: 45px;
      left: 5px;
    }
  </style>
</head>
<body>

<h2>Exam Duty Roster</h2>

<form id="roster-form" onsubmit="event.preventDefault(); submitForm();">
  <div class="row">
    <div class="form-group">
      <label>Exam Year</label>
      <select name="exam_year" required>
        <option value="">--Select Year--</option>
        {% for year in academic_years %}
          <option value="{{ year.year }}">{{ year.year }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="form-group">
      <label>Program</label>
      <select name="program" required>
        <option value="">--Select Program--</option>
      </select>
    </div>
    <div class="form-group">
      <label>Semester</label>
      <select name="semester" required>
        <option value="">--Select Semester--</option>
        {% for sem in semesters %}
          <option value="{{ sem }}">{{ sem }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="form-group">
      <label>Exam Type</label>
      <select name="exam_type" required>
        <option value="">--Select Type--</option>
        <option value="regular">Regular</option>
        <option value="supply_rec">Retake/Supplementary</option>
        <option value="special">Special</option>
      </select>
    </div>
    <div class="form-group">
      <label>Chair of Exam Committee</label>
      <select name="chair_exam_committee">
          <option value="">--Select Chair--</option>
      {% for teacher in teachers %}
        <option value="{{ teacher.id }}">{{ teacher.full_name_en }}</option>
      {% endfor %}
      </select>
    </div>
  </div>

  <hr><br>
  <div id="courses"></div>

  <template id="course-template">
    <div class="course-row">
      <div class="row">
        <div class="form-group">
          <label>Course Code</label>
          <select name="course_code" required></select>
        </div>
        <div class="form-group">
          <label>Date</label>
          <input type="date" name="exam_date" required>
        </div>
        <div class="form-group">
          <label>Time</label>
          <select name="exam_session" required>
            <option value="morning">Morning</option>
            <option value="evening">Evening</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="form-group">
            <label>Head Examiner</label>
            <select name="head_examiner">
                <option value="">--Select Head Examiner--</option>
            {% for teacher in teachers %}
              <option value="{{ teacher.full_name_ansi }}">{{ teacher.full_name_en }}</option>
            {% endfor %}
            </select>
          </div>
        <div class="form-group">
          <label>Envisilators</label>
          <select name="envisilators" multiple>
             {% for teacher in teachers %}
              <option value="{{ teacher.full_name_ansi }}" data-short="{{ teacher.short_name_en }}">{{ teacher.full_name_en }}</option>
             {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label>Assistants</label>
          <select name="assistants" multiple>
            {% for officer in officers %}
              <option value="{{ officer.full_name_ansi }}" data-data_of_birth="{{ officer.data_of_birth }}" data-designation="{{ officer.designation }}" data-short="{{ officer.short_name_en }}">{{ officer.full_name_en }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="close-container" onclick="removeCourseRow(this)">
        <div class="leftright"></div>
        <div class="rightleft"></div>
        <label class="close">close</label>
      </div>
    </div>
  </template>

  <button type="button" onclick="addCourseRow()">Add Course</button>
  <button type="submit">Generate</button>
</form>

<!-- div for url -->
<div id="url-container" style="display: none;">
  <input type="text" id="submit_exam_roster_url" value="{% url 'exam_duty_roster' %}" readonly>
</div>



<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>

// Get Programs based on Academic Year
document.querySelector('select[name="exam_year"]').addEventListener('change', function() {
    const academic_year = this.value;
    const programSelect = document.querySelector('select[name="program"]');
    programSelect.innerHTML = '<option value="">--Select Program--</option>';

    if (academic_year) {
        fetch(`/academic/get_program/?academic_year=${academic_year}`)
        .then(response => response.text())
        .then(data => {
            const programs = data.split(', ');
            programs.forEach(program => {
                const option = document.createElement('option');
                option.value = program;
                option.textContent = program;
                programSelect.appendChild(option);
            });
        })
        .catch(err => console.error('Error fetching programs:', err));
    }
});


// get course codes from server based om Academic Year, Semester and Program values
function updateCourseOptions(selectElem, academic_year, program, semester) {
  console.log('Selected Element', selectElem);
  console.log('Program:', program, 'Semester:', semester);
  selectElem.innerHTML = '<option value="">--Select--</option>';
  if (academic_year && program && semester) {
      fetch(`/academic/get_yearly_courses_code/?academic_year=${academic_year}&semester=${semester}&program=${program}`)
      .then(response => response.text())
      .then(data => {
          console.log('Fetched Course Codes:', data);
          const courseCodes = data.split(', ');
          courseCodes.forEach(code => {
              const option = document.createElement('option');
              option.value = code;
              option.textContent = code;
              selectElem.appendChild(option);
          });
      })
      .catch(err => console.error('Error fetching course codes:', err));
  }
}





const submit_exam_roster_url = document.getElementById('submit_exam_roster_url').value;


const coursesByProgramSemester = {
    "BTIS": {
      "1st": ["1101", "1102", "1103", "1104", "1105",  ],
      "2nd": ["1201", "1202", "1203", "1204", "1205",  ],
      "3rd": ["2301", "2302", "2303", "2304", "2305",  ],
      "4th": ["2401", "2402", "2403", "2404", "2405",  ],
      "5th": ["3501", "3502", "3503", "3504", "3505", "3506" ],
      "6th": ["3601", "3602", "3603", "3604", "3605", "3606" ],
      "7th": ["411", "412", "413", "414", "415",  "416" ],
      "8th": ["421", "422", "423", "424", "425", "426" ],
    },
    "MTIS": {
      "1st": ["5101", "5102", "5103", "5104", "5105", "5106", "5107"],
      "2nd": ["5201", "5202", "5203", "5204", "5205", "5206", "5207"],
      
    }
  };

function initializeSelect2(context) {
  $(context).find('select[name="envisilators"], select[name="assistants"]').select2({
    maximumSelectionLength: 6,
    width: '100%',
    templateSelection: (opt) => $(opt.element).data('short') || opt.text,
  });
}

/*
function updateCourseOptions(selectElem, program, semester) {
  selectElem.innerHTML = '<option value="">--Select--</option>';
  const courses = coursesByProgramSemester[program]?.[semester] || [];
  courses.forEach(code => {
    const option = document.createElement('option');
    option.value = code;
    option.textContent = code;
    selectElem.appendChild(option);
  });
}
*/

function addCourseRow() {
  const container = document.getElementById('courses');
  const template = document.getElementById('course-template');
  const clone = template.content.cloneNode(true);
  container.appendChild(clone);

  const lastRow = container.querySelector('.course-row:last-child');
  initializeSelect2(lastRow);

  const program = document.querySelector('select[name="program"]').value;
  const semester = document.querySelector('select[name="semester"]').value;
  const academic_year = document.querySelector('select[name="exam_year"]').value;
  const courseSelect = lastRow.querySelector('select[name="course_code"]');
  updateCourseOptions(courseSelect, academic_year, program, semester);
}

function removeCourseRow(button) {
  button.closest('.course-row').remove();
}

function updateAllCourseCodes() {
  const program = document.querySelector('select[name="program"]').value;
  const semester = document.querySelector('select[name="semester"]').value;
  const academic_year = document.querySelector('select[name="exam_year"]').value;

  document.querySelectorAll('select[name="course_code"]').forEach(selectElem => {
    updateCourseOptions(selectElem, academic_year, program, semester);
  });
}

// CSRF for Django
function getCookie(name) {
  let cookieValue = null;
  document.cookie.split(';').forEach(cookie => {
    const trimmed = cookie.trim();
    if (trimmed.startsWith(name + '=')) {
      cookieValue = decodeURIComponent(trimmed.substring(name.length + 1));
    }
  });
  return cookieValue;
}

// SUBMIT AS JSON
function submitForm() {
  const form = document.getElementById('roster-form');
  const data = {
    program: form.program.value,
    semester: form.semester.value,
    exam_year: form.exam_year.value,
    exam_type: form.exam_type.value,
    chair_exam_committee: form.chair_exam_committee.value,
    courses: []
  };

  document.querySelectorAll('.course-row').forEach(row => {
    data.courses.push({
      course_code: row.querySelector('select[name="course_code"]').value,
      exam_date: row.querySelector('input[name="exam_date"]').value,
      exam_session: row.querySelector('select[name="exam_session"]').value,
      head_examiner: row.querySelector('select[name="head_examiner"]').value,
      envisilators: $(row).find('select[name="envisilators"]').val() || [],
      assistants: $(row).find('select[name="assistants"]').val() || []
    });
  });

  fetch(submit_exam_roster_url, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify(data)
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    const disposition = response.headers.get('Content-Disposition');
    const match = disposition && disposition.match(/filename="?(.+)"?/);
    console.log(disposition)
    const filename = match ? match[1] : 'exam_roster.docx';

    return response.blob().then(blob => ({ blob, filename })); // receive binary file
  })
  .then(({ blob, filename }) => {
    // Create a link and trigger download
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    window.URL.revokeObjectURL(url);
  })
  .catch(err => {
    alert('Submission failed!');
    console.error(err);
  });

}

document.addEventListener('DOMContentLoaded', () => {
  addCourseRow();
  document.querySelector('select[name="program"]').addEventListener('change', updateAllCourseCodes);
  document.querySelector('select[name="semester"]').addEventListener('change', updateAllCourseCodes);
});
</script>
</body>
</html>
